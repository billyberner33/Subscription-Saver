<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Subscription Save Offer Agent</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <h1>Subscription Save Offer Agent</h1>
        <p class="subhead">
          Agentic prototype: chooses the <span class="emph">smallest effective</span> save offer with explainable tradeoffs.
          Data + impact simulation are mocked; the OpenAI decision is real when an API key is configured.
        </p>
      </header>

      <section class="panel">
        <h2>Scenario</h2>
        <div class="row">
          <label>
            Customer
            <select id="customerId">
              {% for c in customers %}
              <option value="{{ c.customer_id }}">{{ c.customer_id }} — {{ c.name }} ({{ c.segment }})</option>
              {% endfor %}
            </select>
          </label>

          <label>
            Cancellation reason
            <select id="reason">
              {% for r in reasons %}
              <option value="{{ r[0] }}">{{ r[1] }}</option>
              {% endfor %}
            </select>
          </label>

          <button id="runBtn" class="primary">Recommend offer</button>
        </div>
        <p class="hint">
          Tip: try <code>cust_1001</code> + “Not using it enough” (pause), or <code>cust_1002</code> + “Too expensive” (discount).
        </p>
      </section>

      <section class="grid">
        <div class="panel">
          <h2>Recommendation</h2>
          <div id="recStatus" class="muted">Run the agent to see a decision.</div>
          <div id="rec" class="card hidden"></div>
          <div class="actions hidden" id="applyWrap">
            <button id="applyBtn">Apply offer (mock)</button>
            <span id="applyResult" class="muted"></span>
          </div>
        </div>

        <div class="panel">
          <h2>Customer context</h2>
          <div class="muted">Loyalty + cancellation history used by the agent.</div>
          <div id="loyalty" class="card hidden"></div>
          <details class="details">
            <summary>Cancellation events (latest)</summary>
            <pre id="cancellations" class="pre small">[]</pre>
          </details>
          <h2 class="mt">Audit log</h2>
          <div class="muted">Tool calls + mocked system data used by the agent.</div>
          <pre id="audit" class="pre">[]</pre>
        </div>
      </section>

      <footer class="footer muted">
        Built for a Commerce PM interview assignment (Option 2).
      </footer>
    </main>

    <script>
      const el = (id) => document.getElementById(id);
      const state = { lastDecision: null };

      async function loadCustomerContext() {
        const customer_id = el("customerId").value;
        const reason = el("reason").value;
        const res = await fetch(
          `/api/customer/${encodeURIComponent(customer_id)}/loyalty?cancellation_reason=${encodeURIComponent(reason)}`
        );
        const payload = await res.json();
        if (!res.ok) {
          el("loyalty").classList.add("hidden");
          el("cancellations").textContent = "[]";
          return;
        }

        const l = payload.loyalty ?? {};
        const unsub = payload.unsubscribe_estimate ?? {};
        const reasons = l.cancellation_reason_history ?? {};
        const reasonPairs = Object.entries(reasons)
          .sort((a, b) => b[1] - a[1])
          .map(([k, v]) => `${k}: ${v}`)
          .join(", ");

        const unsubPct = unsub.unsubscribe_risk != null ? Math.round(Number(unsub.unsubscribe_risk) * 100) : null;
        const drivers = (unsub.drivers ?? []).slice(0, 5).join(", ");

        el("loyalty").innerHTML = `
          <div class="kvs">
            <div><div class="k">Tenure (months)</div><div class="v">${escapeHtml(l.tenure_months ?? "")}</div></div>
            <div><div class="k">Total spend (USD)</div><div class="v">$${escapeHtml(Number(l.total_spend_usd ?? 0).toFixed(2))}</div></div>
            <div><div class="k">Avg daily minutes</div><div class="v">${escapeHtml(l.avg_daily_minutes ?? "")}</div></div>
            <div><div class="k">Avg weekly sessions</div><div class="v">${escapeHtml(l.avg_weekly_sessions ?? "")}</div></div>
            <div><div class="k">NPS</div><div class="v">${escapeHtml(l.nps ?? "")}</div></div>
            <div><div class="k">Cancel attempts (12m)</div><div class="v">${escapeHtml(l.cancellation_attempts_12m ?? "")}</div></div>
            <div><div class="k">Last cancel attempt</div><div class="v">${escapeHtml(l.last_cancellation_attempt_date ?? "—")}</div></div>
            <div><div class="k">Cancel reasons</div><div class="v">${escapeHtml(reasonPairs || "—")}</div></div>
            <div><div class="k">Discount sensitivity</div><div class="v">${escapeHtml(l.discount_sensitivity ?? "")}</div></div>
            <div><div class="k">Loyalty score</div><div class="v">${escapeHtml(l.loyalty_score ?? "")}</div></div>
            <div><div class="k">Unsubscribe likelihood</div><div class="v">${unsubPct == null ? "—" : `${unsubPct}% (${escapeHtml(unsub.bucket ?? "")})`}</div></div>
            <div><div class="k">Top drivers</div><div class="v">${escapeHtml(drivers || "—")}</div></div>
          </div>
        `;
        el("loyalty").classList.remove("hidden");
        el("cancellations").textContent = JSON.stringify(payload.cancellation_events ?? [], null, 2);
      }

      function setLoading(isLoading) {
        el("runBtn").disabled = isLoading;
        el("runBtn").textContent = isLoading ? "Thinking…" : "Recommend offer";
      }

      function renderDecision(decision) {
        const offerId = decision.selected_offer_id ?? "(missing)";
        const isCustomDiscount = offerId === "offer_custom_discount";
        const outcomes = decision.expected_outcomes ?? {};
        const tradeoffs = (decision.tradeoffs ?? []).map((t) => `<li>${escapeHtml(t)}</li>`).join("");
        const alts = (decision.alternatives_considered ?? []).map((t) => `<li>${escapeHtml(t)}</li>`).join("");
        const risks = (decision.risk_flags ?? []).map((t) => `<li>${escapeHtml(t)}</li>`).join("");
        const discountLine = isCustomDiscount
          ? `<div><div class="k">Discount</div><div class="v">${escapeHtml(String(decision.discount_percent ?? ""))}% for ${escapeHtml(String(decision.discount_duration_months ?? ""))} mo</div></div>`
          : "";

        el("rec").innerHTML = `
          <div class="kvs">
            <div><div class="k">Selected offer</div><div class="v"><code>${escapeHtml(offerId)}</code></div></div>
            <div><div class="k">Confidence</div><div class="v">${escapeHtml(decision.confidence ?? "")}</div></div>
            ${discountLine}
            <div><div class="k">Retention uplift</div><div class="v">${escapeHtml(String(outcomes.retention_uplift ?? ""))}</div></div>
            <div><div class="k">Margin impact</div><div class="v">${escapeHtml(String(outcomes.margin_impact ?? ""))}</div></div>
            <div><div class="k">Predicted churn risk</div><div class="v">${escapeHtml(String(outcomes.predicted_churn_risk ?? ""))}</div></div>
          </div>
          <hr />
          <h3>Why this offer</h3>
          <p>${escapeHtml(decision.why_this_offer ?? "")}</p>
          <h3>Customer message</h3>
          <p class="quote">${escapeHtml(decision.customer_message ?? "")}</p>
          <details open>
            <summary>Tradeoffs</summary>
            <ul>${tradeoffs || "<li class='muted'>None provided</li>"}</ul>
          </details>
          <details>
            <summary>Alternatives considered</summary>
            <ul>${alts || "<li class='muted'>None provided</li>"}</ul>
          </details>
          <details>
            <summary>Risk flags</summary>
            <ul>${risks || "<li class='muted'>None provided</li>"}</ul>
          </details>
          <details>
            <summary>Agent notes (internal)</summary>
            <p class="muted">${escapeHtml(decision.agent_notes ?? "")}</p>
          </details>
        `;
        el("rec").classList.remove("hidden");
        el("applyWrap").classList.remove("hidden");
      }

      function escapeHtml(s) {
        return String(s).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
      }

      el("runBtn").addEventListener("click", async () => {
        setLoading(true);
        el("recStatus").textContent = "Running agent…";
        el("applyResult").textContent = "";
        el("rec").classList.add("hidden");
        el("applyWrap").classList.add("hidden");

        const customer_id = el("customerId").value;
        const cancellation_reason = el("reason").value;
        await loadCustomerContext();
        const res = await fetch("/api/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ customer_id, cancellation_reason }),
        });
        const payload = await res.json();
        el("audit").textContent = JSON.stringify(payload.audit_log ?? [], null, 2);

        if (payload.status === "missing_api_key") {
          el("recStatus").textContent = "Missing OPENAI_API_KEY. Set it in .env and restart the server.";
          setLoading(false);
          return;
        }
        if (payload.status !== "ok" || !payload.decision) {
          el("recStatus").textContent = payload.error ? `Error: ${payload.error}` : "No decision returned.";
          setLoading(false);
          return;
        }

        state.lastDecision = payload.decision;
        el("recStatus").textContent = "";
        renderDecision(payload.decision);
        setLoading(false);
      });

      el("applyBtn").addEventListener("click", async () => {
        if (!state.lastDecision) return;
        const customer_id = el("customerId").value;
        const selected_offer_id = state.lastDecision.selected_offer_id;
        el("applyBtn").disabled = true;
        const applyPayload = { customer_id, selected_offer_id };
        if (selected_offer_id === "offer_custom_discount") {
          applyPayload.discount_percent = state.lastDecision.discount_percent;
          applyPayload.discount_duration_months = state.lastDecision.discount_duration_months;
        }
        const res = await fetch("/api/apply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(applyPayload),
        });
        const applyResult = await res.json();
        el("applyResult").textContent = applyResult.ok ? "Applied (mock) ✓" : "Failed to apply";
        el("applyBtn").disabled = false;
      });

      el("customerId").addEventListener("change", () => loadCustomerContext());
      el("reason").addEventListener("change", () => loadCustomerContext());
      loadCustomerContext();
    </script>
  </body>
</html>
